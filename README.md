# VICRes-CASCADE-3S
This repository contains all the necessary information and code to run the integrated VICRes-CASCADE framework on the 3S Basin and replicate the results presented in "Powering Rivers Sustainably: Integrating Sediment Management and Dam Operations into Hydropower Planning".
## Repository Structure
### VICRes_CASCADE_3S
The VICRes_CASCADE_3S folder contains the code to execute the integrated VICRes-CASCADE framework and reproduce the results described in the section 'Cumulative dam impacts on 3S sediment flow'.
The script orchestratorscenario.py runs the integrated model 16 times, each corresponding to a different sediment budget scenario, and stores the results in folders Results1, Results2, ..., Results16 located in VICRES/RoutingSetup3S.
#### Steps to Execute the Model
##### 1. Compile VICRes:
Follow the instructions on the official VICRes repository: [Critical-Infrastructure-Systems-Lab/VICRes](https://github.com/Critical-Infrastructure-Systems-Lab/VICRes).
At the end of the process, make sure that the executable 'rout' is present in VICRes/Routing/SourceCode.
##### 2. Download Input Data:
Download the Input2000 folder from Zenodo and place it in VICRES/RoutingSetup3S. This folder contains the baseflow and runoff input files for the period 2000–2022, generated by running VIC with temperature and precipitation data for the same period. DIRE DOVE PIAZZARE LA CARTELLA PER FARLA FUNZIONARE!
##### 3. Install Required Libraries:
Ensure all libraries used in DCASCADE_3S.py and orchestratorscenario.py are installed. Use pip or your preferred package manager to install missing dependencies.
##### 4. Run the Model:
Navigate to the VICRes_CASCADE_3S directory and execute:
```bash
python orchestratorscenario.py
```
Upon completion, the results will be saved in the folders Results1, Results2, ..., Results16 within VICRES/RoutingSetup3S. Each folder will include both VICRes outputs and CASCADE outputs.
- **VICRes outputs**: These include discharge and hydropower production data. Specifically:
  - 75STA.day: Contains the discharge data at the outlet section (Stung Treng).
  - OUTPUT.day: COntains the discharge data in all the 463 stations considered
  - reservoir_ID_75STA.day: Contains the discharge data for the reservoir 'ID', where ID corresponds to the specific reservoir ID.
- **CASCADE outputs**: This includes the total annual sediment load at Stung Treng, saved in the file totsedyear.csv
### VICRes_CASCADE_3S_Opt
The VICRES_CASCADE_3S_Opt folder contains the code to execute the optimization of parameters governing water and sediment releases from reservoirs and to reproduce the results described in the sections 'Optimizing Water and Sediment Dam Re-operation Strategies', 'Strategic Flushing for Sediment Management', and 'Coordinated Sluicing for Sediment Flow'.
The script optimization.py, located in VICRes/RoutingOpt/OptCalib, optimizes these parameters using EMODPS. The specifications for the optimization process — such as the number of function evaluations, population size, number of CPU cores, objectives, and reservoirs considered — are defined in the file reservoiroptimization.txt in VICRes/RoutingSetup3S_Opt.
If you run the optimization using multiple CPU cores, ensure that the appropriate number of folders are prepared in RoutingSetupCores (one folder per core) to enable parallel execution of the coupled framework. Each core requires its own folder to manage separate socket connections and store individual results.
Upon completion, the Pareto-optimal solutions are saved in the file optimization_objectives.txt in VICRes/RoutingSetup3S_Opt/Results, while the paramterizations of reservoir policies are saved in optimization_variables.txt in the same folder.
#### Steps to Execute the Model
##### 1. Compile VICRes:
As in the first step of this work, VICRes needs to be compiled. Follow the instructions on the official VICRes repository: [Critical-Infrastructure-Systems-Lab/VICRes](https://github.com/Critical-Infrastructure-Systems-Lab/VICRes). In this case, we use a slightly modified version of VICRes that directly reads pre-saved unit hydrographs for each reservoir and station, eliminating the need to recreate them for every evaluation function. Similarly, the flows reaching each reservoir and station—resulting solely from runoff and baseflow inputs—are also pre-saved, as they are independent of reservoir releases. In this folder, VICRes reads these pre-saved flows directly, avoiding the need to repeat convolutions for each reservoir and station. This approach significantly reduces computational time, allowing the optimization process to consider a much larger number of evaluation functions.
##### 2. Download Input Data:
Download the Input_2008_2022 folder from Zenodo and place it in VICRes folder. This folder contains the baseflow and runoff input files for the period 2008–2022, generated by running VIC with temperature and precipitation data for the same period. DIRE DOVE PIAZZARE LA CARTELLA PER FARLA FUZIONARE!!
##### 3. Install Required Libraries:
Ensure all libraries used in DCASCADE_3S_Opt.py and orchestratorOpt.py are installed. Ensure all libraries used in DCASCADE_3S_Opt.py and orchestratorOpt.py are installed. In this case, a modified version of CASCADE is used to improve computational efficiency, leveraging the numba library to compile functions and significantly reduce runtime.
##### 4. Run the Model:
Navigate to the VICRes/RoutingOpt/OptCalib directory and execute:
```bash
python optimization.py
```
To optimize only the parameters governing the water rule curve, modify line 422 in optimization.py inserting 'os.chdir('../ReservoirsOptWater')'.
Similarly, to optimize parameters for both the water rule curve and sediment flushing, modify the line to 'os.chdir('../ReservoirsOptFlush')'.
For optimizing parameters for the water rule curve and sediment sluicing, modify the line to 'os.chdir('../ReservoirsOptSluic')'.
Each of these settings requires running a separate optimization process.

Upon completion, the Pareto-optimal solutions are saved in the file optimization_objectives.txt in VICRes/RoutingSetup3S_Opt/Results. This file contains the values for each of the three objectives considered for all Pareto-optimal solutions.

### VICRes_CASCADE_3S_Transboundary
intro di cosa fa questa cartella
#### Steps to Execute the Model
##### 1. Compile VICRes:
ipse dixim
##### 2. Locate Input Data:
ipse dixim
##### 3. Run the Model:
ipse dixim...
Navigate to the VICRes/RoutingOpt/OptCalib directory and execute:
```bash
python optimization.py
```
To optimize only the parameters governing the water rule curve, modify line 422 in optimization.py inserting 'os.chdir('../ReservoirsOptWater')'.
Similarly, to optimize parameters for both the water rule curve and sediment flushing, modify the line to 'os.chdir('../ReservoirsOptFlush')'.
For optimizing parameters for the water rule curve and sediment sluicing, modify the line to 'os.chdir('../ReservoirsOptSluic')'.
Each of these settings requires running a separate optimization process.

Upon completion, the Pareto-optimal solutions are saved in the file optimization_objectives.txt in VICRes/RoutingSetup3S_Opt/Results. This file contains the values for each of the three objectives considered for all Pareto-optimal solutions.

### Figures
The Figures folder contains all the scripts needed to reproduce the figures presented in the paper "Powering Rivers Sustainably: Integrating Sediment Management and Dam Operations into Hydropower Planning". Each figure script is located in its respective folder (Figure1, Figure2, ..., Figure5) and relies on the results of simulations and optimizations found in the preceding folders (VICRes_CASCADE_3S and VICRES_CASCADE_3S_Opt).
Before running the scripts, ensure that all the libraries listed in the first cell of each Jupyter notebook are correctly installed. Each script will automatically generate a PDF containing the corresponding figure.
